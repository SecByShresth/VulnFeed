name: üîê Inject API Keys and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        
      - name: üîê Inject API Keys
        run: |
          echo "üìå Starting API key injection..."
          
          # Check if secrets are set (without revealing values)
          if [ -n "${{ secrets.CENSYS_API_TOKEN }}" ]; then echo "‚úÖ CENSYS_API_TOKEN is set"; else echo "‚ö†Ô∏è CENSYS_API_TOKEN not set"; fi
          if [ -n "${{ secrets.SHODAN_API_KEY }}" ]; then echo "‚úÖ SHODAN_API_KEY is set"; else echo "‚ö†Ô∏è SHODAN_API_KEY not set"; fi
          if [ -n "${{ secrets.ABUSEIPDB_API_KEY }}" ]; then echo "‚úÖ ABUSEIPDB_API_KEY is set"; else echo "‚ö†Ô∏è ABUSEIPDB_API_KEY not set"; fi
          if [ -n "${{ secrets.VT_API_KEY }}" ]; then echo "‚úÖ VT_API_KEY is set"; else echo "‚ö†Ô∏è VT_API_KEY not set"; fi
          
          # Replace placeholders with actual API keys
          # Using different delimiter (|) to avoid issues with special characters in keys
          sed -i 's|\${CENSYS_API_TOKEN}|${{ secrets.CENSYS_API_TOKEN }}|g' asset-scanner.js
          sed -i 's|\${SHODAN_API_KEY}|${{ secrets.SHODAN_API_KEY }}|g' asset-scanner.js
          sed -i 's|\${ABUSEIPDB_API_KEY}|${{ secrets.ABUSEIPDB_API_KEY }}|g' asset-scanner.js
          sed -i 's|\${VT_API_KEY}|${{ secrets.VT_API_KEY }}|g' asset-scanner.js
          
          # Verify replacement (check if placeholders are gone)
          if grep -q '\${CENSYS_API_TOKEN}' asset-scanner.js; then
            echo "‚ö†Ô∏è CENSYS_API_TOKEN placeholder still exists"
          else
            echo "‚úÖ CENSYS_API_TOKEN injected"
          fi
          
          if grep -q '\${SHODAN_API_KEY}' asset-scanner.js; then
            echo "‚ö†Ô∏è SHODAN_API_KEY placeholder still exists"
          else
            echo "‚úÖ SHODAN_API_KEY injected"
          fi
          
          if grep -q '\${ABUSEIPDB_API_KEY}' asset-scanner.js; then
            echo "‚ö†Ô∏è ABUSEIPDB_API_KEY placeholder still exists"
          else
            echo "‚úÖ ABUSEIPDB_API_KEY injected"
          fi
          
          if grep -q '\${VT_API_KEY}' asset-scanner.js; then
            echo "‚ö†Ô∏è VT_API_KEY placeholder still exists"
          else
            echo "‚úÖ VT_API_KEY injected"
          fi
          
          # Inject Proxy URL (for CORS bypass)
          if [ -n "${{ secrets.PROXY_URL }}" ]; then
            echo "‚úÖ PROXY_URL is set"
            sed -i 's|\${PROXY_URL}|${{ secrets.PROXY_URL }}|g' asset-scanner.js
            echo "‚úÖ PROXY_URL injected"
          else
            echo "‚ö†Ô∏è PROXY_URL not set - Direct API calls will fail due to CORS"
          fi
          
          echo "üéâ API key injection complete!"
        
      - name: üîß Setup Pages
        uses: actions/configure-pages@v4
        
      - name: üì¶ Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
