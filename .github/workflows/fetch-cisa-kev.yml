name: Fetch CISA KEV Daily

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-cisa-kev:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fetch CISA Known Exploited Vulnerabilities
        run: |
          mkdir -p data

          echo "üîç Fetching CISA KEV catalog..."
          HTTP_CODE=$(curl -w "%{http_code}" \
               "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json" \
               -o data/cisa-kev.json)

          echo "üì° HTTP Response Code: $HTTP_CODE"
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "‚ùå Error: Failed to fetch CISA data with HTTP code $HTTP_CODE"
            exit 1
          fi

          if [ ! -s data/cisa-kev.json ]; then
            echo "‚ùå Error: Downloaded file is empty"
            exit 1
          fi

          VULN_COUNT=$(grep -o '"cveID"' data/cisa-kev.json | wc -l)
          FILE_SIZE=$(wc -c < data/cisa-kev.json)

          echo "‚úÖ Successfully fetched CISA KEV data"
          echo "üì¶ File size: $FILE_SIZE bytes"
          echo "üî¢ Total vulnerabilities: $VULN_COUNT"

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add data/cisa-kev.json

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No changes to CISA KEV data"
            exit 0
          fi

          git commit -m "üîÑ Update CISA KEV data - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          # Safe sync with remote
          git stash
          git pull --rebase origin main || git rebase --abort
          git stash pop || true

          git push origin main
          echo "‚úÖ Successfully pushed updated CISA KEV data to repository"
