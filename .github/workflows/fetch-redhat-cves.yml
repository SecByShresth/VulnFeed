name: Fetch Red Hat CVEs Daily

on:
  schedule:
    - cron: '30 */6 * * *'  # Every 6 hours at 30 minutes past (offset from CISA)
  workflow_dispatch:         # Allows manual triggering

permissions:
  contents: write

jobs:
  fetch-redhat-cves:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
        
      - name: Setup Python for JSON processing
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install requests
          
      - name: Fetch and Process Red Hat CVE Data
        run: |
          mkdir -p data
          
          echo "üîç Fetching Red Hat CVE data..."
          
          # Remove the date filter to get ALL CVEs
          echo "üìÖ Fetching ALL CVEs (no date filter)"
          
          # Fetch Red Hat CVE list (no API key needed!)
          HTTP_CODE=$(curl -w "%{http_code}" \
               "https://access.redhat.com/hydra/rest/securitydata/cve.json" \
               -H "Accept: application/json" \
               -o data/redhat-cves-list.json \
               --retry 3 \
               --retry-delay 5 \
               --max-time 120)
          
          echo "üì° HTTP Response Code for CVE list: $HTTP_CODE"
          
          # Check if request was successful
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "‚ùå Error: Failed to fetch Red Hat CVE list with HTTP code $HTTP_CODE"
            cat data/redhat-cves-list.json
            exit 1
          fi
          
          # Check if file has content
          if [ ! -s data/redhat-cves-list.json ]; then
            echo "‚ùå Error: Downloaded CVE list file is empty"
            exit 1
          fi
          
          # Validate JSON format
          if ! jq empty data/redhat-cves-list.json 2>/dev/null; then
            echo "‚ùå Error: Invalid JSON format in CVE list"
            cat data/redhat-cves-list.json
            exit 1
          fi
          
          # Get CVE count and names from the list
          CVE_COUNT=$(jq '. | length' data/redhat-cves-list.json)
          echo "üìã Found $CVE_COUNT CVEs in list"
          
          # Use Python script to fetch detailed CVE data - REMOVED THE 100 LIMIT
          python << EOF
          import json
          import requests
          import time
          import os
          
          # Read the CVE list
          with open('data/redhat-cves-list.json', 'r') as f:
              cve_list = json.load(f)
          
          print(f"Processing {len(cve_list)} CVEs...")
          
          detailed_cves = []
          failed_cves = []
          
          # Fetch details for each CVE - NO LIMIT, process all CVEs
          total_cves = len(cve_list)
          
          for i, cve in enumerate(cve_list):
              cve_name = cve.get('CVE', cve.get('name', 'Unknown'))
              print(f"Fetching {i+1}/{total_cves}: {cve_name}")
              
              try:
                  # Fetch individual CVE details
                  url = f"https://access.redhat.com/hydra/rest/securitydata/cve/{cve_name}.json"
                  response = requests.get(url, timeout=30)
                  
                  if response.status_code == 200:
                      detailed_cve = response.json()
                      detailed_cves.append(detailed_cve)
                      print(f"  ‚úÖ Success: {cve_name}")
                  else:
                      print(f"  ‚ùå Failed: {cve_name} - HTTP {response.status_code}")
                      failed_cves.append(cve_name)
                      
              except Exception as e:
                  print(f"  ‚ùå Error fetching {cve_name}: {str(e)}")
                  failed_cves.append(cve_name)
              
              # Be nice to the API - small delay between requests
              time.sleep(0.5)
          
          # Save detailed CVEs
          with open('data/redhat-cves.json', 'w') as f:
              json.dump(detailed_cves, f, indent=2)
          
          print(f"\\n‚úÖ Successfully fetched {len(detailed_cves)} detailed CVE records")
          if failed_cves:
              print(f"‚ùå Failed to fetch {len(failed_cves)} CVEs: {failed_cves}")
          
          # Also save summary with all CVE names
          summary = {
              "total_cves_in_list": len(cve_list),
              "detailed_cves_fetched": len(detailed_cves),
              "failed_cves": failed_cves,
              "cve_names": [cve.get('CVE', cve.get('name', 'Unknown')) for cve in cve_list]
          }
          
          with open('data/redhat-cves-summary.json', 'w') as f:
              json.dump(summary, f, indent=2)
          EOF
          
          # Get stats from the detailed file
          if [ -f data/redhat-cves.json ] && [ -s data/redhat-cves.json ]; then
            DETAILED_COUNT=$(jq '. | length' data/redhat-cves.json)
            CRITICAL_COUNT=$(jq '[.[] | select(.threat_severity == "Critical")] | length' data/redhat-cves.json)
            IMPORTANT_COUNT=$(jq '[.[] | select(.threat_severity == "Important")] | length' data/redhat-cves.json)
            MODERATE_COUNT=$(jq '[.[] | select(.threat_severity == "Moderate")] | length' data/redhat-cves.json)
            LOW_COUNT=$(jq '[.[] | select(.threat_severity == "Low")] | length' data/redhat-cves.json)
            
            echo "‚úÖ Successfully processed Red Hat CVE data"
            echo "üì¶ Detailed CVEs fetched: $DETAILED_COUNT"
            echo "üî¥ Critical: $CRITICAL_COUNT"
            echo "üü† Important: $IMPORTANT_COUNT"
            echo "üü° Moderate: $MODERATE_COUNT"
            echo "üü¢ Low: $LOW_COUNT"
          else
            echo "‚ùå Error: Failed to generate detailed CVE data"
            exit 1
          fi
          
          # Create a summary file with metadata
          cat > data/redhat-cves-metadata.json << EOF
          {
            "last_updated": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
            "total_cves_in_list": $CVE_COUNT,
            "detailed_cves_fetched": $DETAILED_COUNT,
            "critical_count": $CRITICAL_COUNT,
            "important_count": $IMPORTANT_COUNT,
            "moderate_count": $MODERATE_COUNT,
            "low_count": $LOW_COUNT,
            "date_range": "All Time",
            "notes": "Fetched all available Red Hat CVEs"
          }
          EOF
          
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Get the latest changes to avoid conflicts
          git fetch origin
          git reset --hard origin/main
          
          # Add only the specific files we want to track
          git add data/redhat-cves.json data/redhat-cves-metadata.json data/redhat-cves-list.json data/redhat-cves-summary.json
          
          # Check if there are changes after adding
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to Red Hat CVE data"
          else
            DETAILED_COUNT=$(jq '. | length' data/redhat-cves.json)
            git commit -m "üîÑ Update Red Hat CVE data - $DETAILED_COUNT detailed CVEs (All Time) - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push origin main
            echo "‚úÖ Successfully pushed Red Hat CVE data to repository"
          fi
